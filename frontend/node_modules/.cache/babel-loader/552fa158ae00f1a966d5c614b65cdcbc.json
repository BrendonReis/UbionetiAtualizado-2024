{"ast":null,"code":"import React,{useState,useRef,useEffect,useContext}from\"react\";import{useHistory}from\"react-router-dom\";import{format}from\"date-fns\";import{SocketContext}from\"../../context/Socket/SocketContext\";import useSound from\"use-sound\";import Popover from\"@material-ui/core/Popover\";import IconButton from\"@material-ui/core/IconButton\";import List from\"@material-ui/core/List\";import ListItem from\"@material-ui/core/ListItem\";import ListItemText from\"@material-ui/core/ListItemText\";import{makeStyles}from\"@material-ui/core/styles\";import Badge from\"@material-ui/core/Badge\";import ChatIcon from\"@material-ui/icons/Chat\";import TicketListItem from\"../TicketListItemCustom\";import useTickets from\"../../hooks/useTickets\";import alertSound from\"../../assets/sound.mp3\";import{AuthContext}from\"../../context/Auth/AuthContext\";import{i18n}from\"../../translate/i18n\";import toastError from\"../../errors/toastError\";const useStyles=makeStyles(theme=>({tabContainer:{overflowY:\"auto\",maxHeight:350,...theme.scrollbarStyles},popoverPaper:{width:\"100%\",maxWidth:350,marginLeft:theme.spacing(2),marginRight:theme.spacing(1),[theme.breakpoints.down(\"sm\")]:{maxWidth:270}},noShadow:{boxShadow:\"none !important\"}}));const NotificationsPopOver=_ref=>{let{volume}=_ref;const classes=useStyles();const history=useHistory();const{user}=useContext(AuthContext);const ticketIdUrl=+history.location.pathname.split(\"/\")[2];const ticketIdRef=useRef(ticketIdUrl);const anchorEl=useRef();const[isOpen,setIsOpen]=useState(false);const[notifications,setNotifications]=useState(()=>{const savedNotifications=localStorage.getItem(\"notifications\");return savedNotifications?JSON.parse(savedNotifications):[];});console.log(notifications);const[showPendingTickets,setShowPendingTickets]=useState(false);const[,setDesktopNotifications]=useState([]);const{tickets}=useTickets({withUnreadMessages:\"true\"});const[play]=useSound(alertSound,volume);const soundAlertRef=useRef();const historyRef=useRef(history);const socketManager=useContext(SocketContext);useEffect(()=>{const fetchSettings=async()=>{try{if(user.allTicket===\"enable\"){setShowPendingTickets(true);}}catch(err){toastError(err);}};fetchSettings();},[user]);useEffect(()=>{soundAlertRef.current=play;if(!(\"Notification\"in window)){console.log(\"Este navegador não suporta notificações\");}else{Notification.requestPermission();}},[play]);useEffect(()=>{const processNotifications=()=>{if(showPendingTickets){setNotifications(tickets);}else{const newNotifications=tickets.filter(ticket=>ticket.status!==\"pending\");setNotifications(newNotifications);}};processNotifications();},[tickets,showPendingTickets]);useEffect(()=>{ticketIdRef.current=ticketIdUrl;},[ticketIdUrl]);useEffect(()=>{const socket=socketManager.getSocket(user.companyId);socket.on(\"ready\",()=>socket.emit(\"joinNotification\"));socket.on(\"company-\".concat(user.companyId,\"-notification\"),data=>{console.log(\"notification recebida: \",data);if(data.action===\"pendingTicket\"){setNotifications(prevState=>{const ticketIndex=prevState.findIndex(t=>t.id===data.ticket.id);if(ticketIndex!==-1){prevState[ticketIndex]=data.ticket;return[...prevState];}return[data.ticket,...prevState];});const shouldNotNotificate=data.message.ticketId===ticketIdRef.current&&document.visibilityState===\"visible\"||data.ticket.userId&&data.ticket.userId!==(user===null||user===void 0?void 0:user.id)||data.ticket.isGroup;if(shouldNotNotificate)return;}});socket.on(\"company-\".concat(user.companyId,\"-ticket\"),data=>{console.log(\"ticket recebida: \",data);if(data.action===\"updateUnread\"||data.action===\"delete\"){setNotifications(prevState=>{return prevState.filter(t=>t.id!==data.ticketId&&t.ticket&&t.ticket.status!==\"closed\");});setDesktopNotifications(prevState=>{const notificationIndex=prevState.findIndex(n=>n.tag===String(data.ticketId));if(notificationIndex!==-1){prevState[notificationIndex].close();prevState.splice(notificationIndex,1);return[...prevState];}return prevState;});}});socket.on(\"company-\".concat(user.companyId,\"-appMessage\"),data=>{var _user$queues;console.log(\"appMessage recebida: \",data);if(data.action===\"create\"&&!data.message.fromMe&&data.ticket.status!==\"autoassigned\"&&data.ticket.status!==\"pending\"&&(!data.message.read||data.ticket.status===\"autoassigned\")&&(!data.message.read||data.ticket.status===\"pending\")&&(data.ticket.userId===(user===null||user===void 0?void 0:user.id)||!data.ticket.userId)&&((user===null||user===void 0?void 0:(_user$queues=user.queues)===null||_user$queues===void 0?void 0:_user$queues.some(queue=>queue.id===data.ticket.queueId))||!data.ticket.queueId)){setNotifications(prevState=>{const ticketIndex=prevState.findIndex(t=>t.id===data.ticket.id);if(ticketIndex!==-1){prevState[ticketIndex]=data.ticket;return[...prevState];}return[data.ticket,...prevState];});const shouldNotNotificate=data.message.ticketId===ticketIdRef.current&&document.visibilityState===\"visible\"||data.ticket.userId&&data.ticket.userId!==(user===null||user===void 0?void 0:user.id)||data.ticket.isGroup;if(shouldNotNotificate)return;}});return()=>{socket.disconnect();};},[user,showPendingTickets,socketManager]);const handleNotifications=data=>{const{action,message,ticket}=data;if(!ticket||!ticket.id){console.log(\"Ticket inválido ou sem ID. Ignorando a notificação.\");return;}const status=ticket.status;const currentDate=new Date();const ticketUpdatedAt=ticket.updatedAt?new Date(ticket.updatedAt):null;let isDelayed=false;let delayMessage=\"\";if(ticketUpdatedAt&&!isNaN(ticketUpdatedAt.getTime())){const timeDifference=currentDate-ticketUpdatedAt;const oneMinuteInMs=60*1000;if(timeDifference>oneMinuteInMs&&status!==\"closed\"&&status!==\"reopened\"){isDelayed=true;delayMessage=\"Ticket \".concat(ticket.id,\" est\\xE1 atrasado. Atualizado em: \").concat(format(ticketUpdatedAt,\"dd/MM/yyyy HH:mm:ss\"),\" | Data atual: \").concat(format(currentDate,\"dd/MM/yyyy HH:mm:ss\"));console.log(delayMessage);}setNotifications(prevState=>{const ticketIndex=prevState.findIndex(t=>t.id===ticket.id);if(ticketIndex!==-1){prevState[ticketIndex]={...ticket,isDelayed,delayMessage};return[...prevState];}return[{...ticket,isDelayed,delayMessage},...prevState];});}else{console.log(\"Data de atualiza\\xE7\\xE3o inv\\xE1lida para o ticket \".concat(ticket.id));}const iconUrl=ticket.contact&&ticket.contact.profilePicUrl?ticket.contact.profilePicUrl:'default_icon_url.png';if(!ticket.id||!message){console.log(\"Informações insuficientes para criar a notificação.\");return;}const options={body:\"\".concat(message,\" - \").concat(isDelayed?\"Ticket atrasado!\":\"\",\" - \").concat(format(new Date(),\"HH:mm\")),icon:iconUrl,tag:ticket.id,renotify:true};if(Notification.permission===\"granted\"){const notification=new Notification(\"Notifica\\xE7\\xE3o sobre o ticket \".concat(ticket.id),options);notification.onclick=e=>{e.preventDefault();window.focus();history.push(\"/tickets/\".concat(ticket.id));};}if(isDelayed){soundAlertRef.current();}};const handleClick=()=>{setIsOpen(prevState=>!prevState);};const handleClickAway=()=>{setIsOpen(false);};const NotificationTicket=_ref2=>{let{children}=_ref2;return/*#__PURE__*/React.createElement(\"div\",{onClick:handleClickAway},children);};return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(IconButton,{onClick:handleClick,ref:anchorEl,\"aria-label\":\"Open Notifications\",color:\"inherit\",style:{color:\"white\"}},/*#__PURE__*/React.createElement(Badge,{overlap:\"rectangular\",badgeContent:notifications.length,color:\"secondary\"},/*#__PURE__*/React.createElement(ChatIcon,null))),/*#__PURE__*/React.createElement(Popover,{disableScrollLock:true,open:isOpen,anchorEl:anchorEl.current,anchorOrigin:{vertical:\"bottom\",horizontal:\"right\"},transformOrigin:{vertical:\"top\",horizontal:\"right\"},classes:{paper:classes.popoverPaper},onClose:handleClickAway},/*#__PURE__*/React.createElement(List,{dense:true,className:classes.tabContainer},notifications.length===0?/*#__PURE__*/React.createElement(ListItem,null,/*#__PURE__*/React.createElement(ListItemText,{primary:/*#__PURE__*/React.createElement(\"strong\",null,\"Sem notifica\\xE7\\xF5es\")})):notifications.map(ticket=>{console.log(\"Renderizando ticket:\",ticket);return ticket&&ticket.id?/*#__PURE__*/React.createElement(NotificationTicket,{key:ticket.id},/*#__PURE__*/React.createElement(TicketListItem,{ticket:ticket},/*#__PURE__*/React.createElement(\"img\",{src:ticket.contact.profilePicUrl,alt:\"\".concat(ticket.contact.name,\"'s profile\"),style:{width:'48px',height:'48px',borderRadius:'50%',marginRight:'10px'}}),/*#__PURE__*/React.createElement(\"div\",null,/*#__PURE__*/React.createElement(\"strong\",null,ticket.contact.name),/*#__PURE__*/React.createElement(\"br\",null),/*#__PURE__*/React.createElement(\"span\",null,ticket.contact.number))),ticket.isDelayed&&/*#__PURE__*/React.createElement(\"div\",{style:{color:\"red\",fontSize:\"12px\",marginTop:\"5px\"}},ticket.delayMessage)):null;}))));};export default NotificationsPopOver;","map":null,"metadata":{},"sourceType":"module"}